version: '3.9'
name: atlassian_stack
services:
  jira_postgres:
    image: postgres:15
    container_name: jira_postgres
    environment:
      POSTGRES_USER: atlassian
      POSTGRES_PASSWORD: atlassian
      POSTGRES_DB: jiradb
    volumes:
      - jira_postgres_data:/var/lib/postgresql/data
    networks:
      - atlassian_net

  confluence_postgres:
    image: postgres:15
    container_name: confluence_postgres
    environment:
      POSTGRES_USER: atlassian
      POSTGRES_PASSWORD: atlassian
      POSTGRES_DB: confluencedb
    volumes:
      - confluence_postgres_data:/var/lib/postgresql/data
    networks:
      - atlassian_net

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    depends_on:
      - jira_postgres
      - confluence_postgres
    # ports:
    #   - '8080:80'
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - atlassian_net

  jira:
    image: atlassian/jira-software:latest
    container_name: jira
    restart: unless-stopped
    depends_on:
      - jira_postgres
    environment:
      ATL_DB_TYPE: postgres72
      ATL_DB_DRIVER: org.postgresql.Driver
      ATL_JDBC_URL: jdbc:postgresql://jira_postgres:5432/jiradb
      ATL_JDBC_USER: atlassian
      ATL_JDBC_PASSWORD: atlassian
      # set these to your public domain and scheme
      ATL_PROXY_NAME: your.public.domain.example
      ATL_PROXY_PORT: 443
      ATL_TOMCAT_SCHEME: https
    volumes:
      - jira_data:/var/atlassian/application-data/jira
    networks:
      - atlassian_net
  confluence:
    image: atlassian/confluence-server:latest
    container_name: confluence
    restart: unless-stopped
    depends_on:
      - confluence_postgres
    environment:
      ATL_DB_TYPE: postgresql
      ATL_DB_DRIVER: org.postgresql.Driver
      ATL_JDBC_URL: jdbc:postgresql://confluence_postgres:5432/confluencedb
      ATL_JDBC_USER: atlassian
      ATL_JDBC_PASSWORD: atlassian
      # set these to your public domain and scheme
      ATL_PROXY_NAME: your.public.domain.example
      ATL_PROXY_PORT: 443
      ATL_TOMCAT_SCHEME: https
    volumes:
      - confluence_data:/var/atlassian/application-data/confluence
    networks:
      - atlassian_net

  nginx:
    image: nginx:latest
    container_name: reverse_proxy
    restart: unless-stopped
    depends_on:
      - jira
      - confluence
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # mount certs directory if you will use self-managed certs
      - ./certs:/etc/nginx/certs:ro
    ports:
      - '80:80'
      - '443:443'
    networks:
      - atlassian_net

volumes:
  jira_postgres_data:
  confluence_postgres_data:
  jira_data:
  confluence_data:
  pgadmin_data:

networks:
  atlassian_net:
    driver: bridge
